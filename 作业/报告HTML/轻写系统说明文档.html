<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>轻写（QingXie）系统说明文档</title>
  <style>
    :root { --fg: #222; --muted: #666; --border: #cfcfcf; --bg-muted: #f6f6f6; }
    body { font-family: "Microsoft YaHei", "Noto Sans CJK SC", sans-serif; line-height: 1.85; margin: 32px; color: var(--fg); }
    h1, h2, h3, h4 { margin: 0 0 12px; }
    h1 { font-size: 26px; letter-spacing: 0.5px; }
    h2 { font-size: 18px; margin-top: 26px; padding-top: 6px; border-top: 1px solid #eee; }
    h3 { font-size: 15px; margin-top: 18px; }
    h4 { font-size: 14px; margin-top: 14px; }
    p { margin: 10px 0; }
    ul { margin: 8px 0 8px 20px; }
    li { margin: 4px 0; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid var(--border); padding: 8px 10px; vertical-align: top; }
    th { background: #fafafa; }
    code { background: var(--bg-muted); padding: 1px 4px; border-radius: 4px; }
    pre { background: var(--bg-muted); padding: 12px; border-radius: 8px; overflow-x: auto; }
    .muted { color: var(--muted); }
    .cover { padding: 28px 22px; border: 1px solid var(--border); border-radius: 12px; }
    .cover h1 { margin-bottom: 8px; }
    .cover .line { margin: 6px 0; }
    .toc a { color: inherit; text-decoration: none; }
    .toc a:hover { text-decoration: underline; }
    .callout { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 10px 12px; margin: 10px 0; }
    .pagebreak { page-break-before: always; break-before: page; }
  </style>
</head>
<body>
  <div class="cover">
    <h1>轻写（QingXie）系统说明文档</h1>
    <div class="line">项目类型：前后端分离 Web 系统（AI 辅助小说创作平台）</div>
    <div class="line">组长：许正扬　　组员：龚哲炜</div>
    <div class="line">提交时间：2025-12-20</div>
    <div class="line muted">备注：本文档面向课程验收与答辩，包含背景意义、需求分析、架构设计、数据库与接口设计、关键技术与分工说明。</div>
  </div>

  <div class="pagebreak"></div>

  <h2 id="toc">目录</h2>
  <div class="toc">
    <p><a href="#s1">1. 项目背景与意义</a></p>
    <p><a href="#s2">2. 需求分析</a></p>
    <p><a href="#s3">3. 总体架构与模块设计</a></p>
    <p><a href="#s4">4. 技术栈与选型理由</a></p>
    <p><a href="#s5">5. 数据库设计</a></p>
    <p><a href="#s6">6. 接口设计与数据交互</a></p>
    <p><a href="#s7">7. 关键技术点与解决方案</a></p>
    <p><a href="#s8">8. 测试与验收说明</a></p>
    <p><a href="#s9">9. 组内分工与协作方式</a></p>
    <p><a href="#s10">10. 附录（目录结构与环境变量）</a></p>
    <p><a href="#s11">11. 源代码地址</a></p>
  </div>

  <h2 id="s1">1. 项目背景与意义</h2>
  <p>
    网络小说写作属于长期、连续、高强度的内容产出工作，创作者通常需要同时处理多个“信息层”：人物关系、世界设定、主线冲突、章节节奏、伏笔回收等。
    在真实写作场景中，作者往往在笔记软件、思维导图、文本编辑器之间频繁切换，导致“素材与正文脱节”“设定前后不一致”“更新效率低”等问题。
    因此，我们设计并实现了“轻写”平台，将写作过程拆解为清晰的工作流：用户登录 → 创建作品 → 创建章节并写作 → 同步维护大纲/角色/世界观 → 使用 AI 辅助完成续写与润色 → 导出成品。
  </p>
  <p>
    本项目的意义在于：一方面通过结构化管理（大纲、角色、世界观）降低长期创作的记忆负担，另一方面通过 AI 工具（续写、扩写、审稿等）提高写作效率，
    让用户能更快形成可读性更强的成稿，并在同一平台上完成从设定到正文的闭环。
  </p>

  <h2 id="s2">2. 需求分析</h2>
  <h3>2.1 用户角色与使用场景</h3>
  <p>
    系统面向的主要用户是普通创作者（个人用户）。在课程项目范围内，系统不引入复杂的管理员后台，而以“单用户—多作品”的创作场景为主。
    用户主要在浏览器端完成写作与管理操作，后端负责数据存储、鉴权与 AI 调用等能力。
  </p>
  <h3>2.2 功能性需求</h3>
  <p>为了覆盖“从写到用”的完整流程，我们将需求分为六类模块：</p>
  <table>
    <thead>
      <tr><th>模块</th><th>需求点</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>用户</td>
        <td>注册、登录、获取当前用户信息</td>
        <td>登录后持有 Token，后续接口需要鉴权</td>
      </tr>
      <tr>
        <td>作品</td>
        <td>创建、编辑、删除、查看作品列表与详情</td>
        <td>作品信息包括标题、简介、类型、标签、字数、更新时间等</td>
      </tr>
      <tr>
        <td>章节</td>
        <td>创建、编辑、删除、查询、排序、字数统计</td>
        <td>支持在作品下管理多个章节，并可调整顺序</td>
      </tr>
      <tr>
        <td>角色</td>
        <td>角色档案增删改查</td>
        <td>支持性格、背景、关系等字段，用于设定一致性</td>
      </tr>
      <tr>
        <td>大纲/世界观</td>
        <td>大纲条目管理、世界观设定管理</td>
        <td>世界观以“单条可更新”方式维护，避免重复冲突</td>
      </tr>
      <tr>
        <td>AI 工具</td>
        <td>续写、扩写润色、审稿、拆书、起名等</td>
        <td>以工具面板的形式提供，生成结果可用于正文写作</td>
      </tr>
    </tbody>
  </table>
  <h3>2.3 非功能性需求</h3>
  <p>
    除功能之外，课程验收通常会关注可用性与稳定性，因此在实现中重点保障：页面可访问、接口可调用、鉴权可用、数据可持久化、异常可定位、部署步骤清晰。
    对于 AI 接口，由于外部服务可能不可用或未配置 Key，系统应当能给出明确提示，且核心写作与管理功能不受影响。
  </p>

  <h2 id="s3">3. 总体架构与模块设计</h2>
  <h3>3.1 架构概览</h3>
  <p>
    系统采用前后端分离架构。前端负责页面展示与交互；后端提供 REST API 与鉴权；数据库负责数据持久化；AI 服务作为外部能力由后端统一调用。
  </p>
  <div class="callout">
    <strong>架构图（建议截图或绘图后替换）：</strong><br />
    浏览器（前端） → HTTP/JSON → FastAPI（后端） → SQLAlchemy → MySQL<br />
    FastAPI（AI 模块） → HTTP → 豆包大模型 API
  </div>
  <h3>3.2 模块划分</h3>
  <p>
    前端按页面与组件拆分：认证页（注册/登录）、写作工作台（章节编辑器 + 工具面板）、作品库、资料区等。
    后端按功能域拆分路由：认证（auth）、作品（novels）、章节（chapters）、角色（characters）、大纲（outlines）、世界观（world-building）、AI（ai）。
    业务逻辑与模型定义分层，便于维护与测试。
  </p>

  <h2 id="s4">4. 技术栈与选型理由</h2>
  <h3>4.1 前端选型</h3>
  <p>
    前端采用基于 React 的工程体系，使用组件库提高界面一致性和开发效率。路由、布局与交互逻辑由前端负责实现，
    并通过统一 API 与后端交互，确保“页面层”与“数据层”职责清晰。认证部分使用成熟的会话管理方案，降低安全实现难度。
  </p>
  <h3>4.2 后端选型</h3>
  <p>
    后端使用 FastAPI，主要原因是其异步支持良好、接口开发效率高、与 Pydantic 的数据校验配合自然；
    数据层使用 SQLAlchemy（ORM）减少手写 SQL 的成本，同时保留必要的关系约束与事务能力。
  </p>
  <h3>4.3 数据库选型</h3>
  <p>
    数据库存储采用 MySQL（utf8mb4），满足中文内容与长文本存储需求，并能很好地支持多表关联与后续扩展。
  </p>

  <h2 id="s5">5. 数据库设计</h2>
  <h3>5.1 设计原则</h3>
  <p>
    数据库设计遵循“以作品为中心”的业务主线：用户拥有多部作品；每部作品包含多个章节；此外按作品维度扩展角色、大纲与世界观。
    字段命名保持清晰，关键字段建立索引（如 email），并使用外键保证关联一致性。长文本内容（如章节正文、世界观内容）使用 Text 类型存储。
  </p>
  <h3>5.2 实体关系说明</h3>
  <p>
    users（1）—（N）novels；novels（1）—（N）chapters；novels（1）—（N）characters；novels（1）—（N）outlines；
    novels（1）—（1）world_buildings。所有业务数据均以 user_id 做隔离，避免不同用户之间的数据互相访问。
  </p>
  <h3>5.3 核心表字段说明（摘录）</h3>
  <table>
    <thead>
      <tr><th>表</th><th>字段</th><th>类型</th><th>含义与约束</th></tr>
    </thead>
    <tbody>
      <tr>
        <td rowspan="5">users</td>
        <td>id</td><td>VARCHAR(36)</td><td>主键，UUID 字符串</td>
      </tr>
      <tr><td>email</td><td>VARCHAR(255)</td><td>唯一索引，登录账号</td></tr>
      <tr><td>name</td><td>VARCHAR(100)</td><td>昵称，可为空</td></tr>
      <tr><td>password</td><td>VARCHAR(255)</td><td>加密后密码，不存明文</td></tr>
      <tr><td>created_at/updated_at</td><td>DATETIME</td><td>创建/更新时间</td></tr>
      <tr>
        <td rowspan="6">novels</td>
        <td>id</td><td>VARCHAR(36)</td><td>主键，UUID</td>
      </tr>
      <tr><td>title</td><td>VARCHAR(255)</td><td>作品标题，必填</td></tr>
      <tr><td>description</td><td>VARCHAR(500)</td><td>简介，可为空</td></tr>
      <tr><td>genre/tags</td><td>VARCHAR</td><td>作品分类与标签</td></tr>
      <tr><td>word_count/chapter_count</td><td>INT</td><td>统计字段，由后端维护</td></tr>
      <tr><td>user_id</td><td>VARCHAR(36)</td><td>外键，关联 users.id</td></tr>
      <tr>
        <td rowspan="6">chapters</td>
        <td>id</td><td>VARCHAR(36)</td><td>主键，UUID</td>
      </tr>
      <tr><td>title</td><td>VARCHAR(255)</td><td>章节标题</td></tr>
      <tr><td>content</td><td>TEXT</td><td>章节正文</td></tr>
      <tr><td>order</td><td>INT</td><td>章节顺序号，用于排序</td></tr>
      <tr><td>word_count</td><td>INT</td><td>按内容统计字数</td></tr>
      <tr><td>novel_id</td><td>VARCHAR(36)</td><td>外键，关联 novels.id</td></tr>
    </tbody>
  </table>
  <p class="muted">
    说明：完整字段以项目代码中的 SQLAlchemy 模型为准（backend/app/models/）。
  </p>

  <h2 id="s6">6. 接口设计与数据交互</h2>
  <p>
    后端 API 采用 REST 风格，使用 JSON 作为主要数据交换格式；认证接口使用 OAuth2 表单登录方式获取 Token。
    下表列出主要接口（以“典型调用路径”为主，便于验收演示）。实际返回字段以 Swagger（FastAPI 自动文档）为准。
  </p>
  <h3>6.1 认证接口</h3>
  <table>
    <thead><tr><th>接口</th><th>方法</th><th>说明</th></tr></thead>
    <tbody>
      <tr><td>/auth/register</td><td>POST</td><td>注册账号（email、name、password）</td></tr>
      <tr><td>/auth/login</td><td>POST</td><td>登录并获取 access_token（JWT）</td></tr>
      <tr><td>/auth/me</td><td>GET</td><td>获取当前登录用户信息（需 Bearer Token）</td></tr>
    </tbody>
  </table>
  <h4>登录请求示例</h4>
  <pre><code>POST /auth/login
 Content-Type: application/x-www-form-urlencoded

 username=xxx%40qq.com&amp;password=你的密码</code></pre>
  <p>登录成功返回：</p>
  <pre><code>{
  "access_token": "xxxx.yyyy.zzzz",
  "token_type": "bearer"
}</code></pre>

  <h3>6.2 作品与章节接口</h3>
  <table>
    <thead><tr><th>接口</th><th>方法</th><th>说明</th></tr></thead>
    <tbody>
      <tr><td>/novels</td><td>GET</td><td>获取我的作品列表</td></tr>
      <tr><td>/novels</td><td>POST</td><td>创建作品</td></tr>
      <tr><td>/novels/{id}</td><td>GET/PUT/DELETE</td><td>作品详情/更新/删除</td></tr>
      <tr><td>/novels/{id}/chapters</td><td>GET/POST</td><td>章节列表/创建章节</td></tr>
      <tr><td>/novels/{id}/chapters/{chapter_id}</td><td>GET/PUT/DELETE</td><td>章节详情/更新/删除</td></tr>
    </tbody>
  </table>
  <p>
    对于章节，后端按 order + 创建时间排序；当章节内容变更或删除后，会重新统计对应作品的 word_count 与 chapter_count，
    保证前端显示一致。
  </p>

  <h3>6.3 设定模块接口（角色/大纲/世界观）</h3>
  <table>
    <thead><tr><th>模块</th><th>接口（示例）</th><th>说明</th></tr></thead>
    <tbody>
      <tr><td>角色</td><td>/novels/{id}/characters</td><td>角色增删改查</td></tr>
      <tr><td>大纲</td><td>/novels/{id}/outlines</td><td>大纲条目增删改查</td></tr>
      <tr><td>世界观</td><td>/novels/{id}/world-building</td><td>世界观创建/更新/查询</td></tr>
    </tbody>
  </table>

  <h3>6.4 AI 接口</h3>
  <p>
    AI 接口由后端统一对外提供，调用外部大模型服务。为了降低前端复杂度，前端只需要提交上下文与目标，
    后端负责提示词拼装、请求发送、错误处理与结果解析。AI 功能需要在环境变量中配置 Key，未配置时系统会给出可理解的提示。
  </p>
  <table>
    <thead><tr><th>接口</th><th>方法</th><th>说明</th></tr></thead>
    <tbody>
      <tr><td>/ai/continue-writing</td><td>POST</td><td>基于章节上下文进行续写</td></tr>
    </tbody>
  </table>

  <h2 id="s7">7. 关键技术点与解决方案</h2>
  <h3>7.1 鉴权与数据隔离</h3>
  <p>
    系统以 JWT 作为核心鉴权手段。后端在受保护接口中读取 Bearer Token，解析出用户身份；所有作品与章节数据查询都带上 user_id 条件，
    以实现“用户级别的数据隔离”。在接口层面，对于不存在的资源返回 404，对于无权限访问返回 401/403，便于前端区分处理。
  </p>
  <h3>7.2 ORM 与事务处理</h3>
  <p>
    使用 SQLAlchemy ORM 定义模型与关系，减少手写 SQL。涉及“章节变更引起作品统计变更”的场景，采用在同一数据库会话中完成更新与统计重算，
    并在提交后 refresh，保证数据状态一致。
  </p>
  <h3>7.3 字数统计策略</h3>
  <p>
    写作系统对“字数”的口径容易不一致。项目中采用对章节 content 去空白后的长度作为基础统计单位，并在章节保存时更新 chapter.word_count；
    作品的 word_count 与 chapter_count 由后端通过聚合查询重新计算，避免前端误算造成展示偏差。
  </p>
  <h3>7.4 AI 调用的稳定性与可控性</h3>
  <p>
    AI 调用外部服务时可能出现 Key 未配置、网络超时、返回结构变化等问题。为此后端做了三层处理：
    （1）启动时读取环境变量，若缺失则在调用时给出明确错误；（2）设置合理超时并使用异常捕获；（3）对返回结构做健壮解析，
    若缺失关键字段则报出可定位的错误信息，便于排查。
  </p>
  <h3>7.5 可用性与体验</h3>
  <p>
    前端在写作工作台中提供“作品库—章节导航—编辑器—工具面板”的组合布局，避免频繁跳转；在请求过程中展示加载状态与错误提示，
    并在鉴权失败时引导用户重新登录，保证系统整体使用流畅。
  </p>
  <h3>7.6 统一错误处理与接口可维护性</h3>
  <p>
    为了让前端能够明确区分“未登录”“无权限”“资源不存在”“参数错误”等情况，后端采用 HTTP 状态码表达错误类型：
    登录失败返回 401；找不到资源返回 404；参数校验失败返回 422；业务拒绝/无权限访问返回 403。前端根据状态码进行差异化处理，
    例如遇到 401 时跳转登录页，遇到 404 时提示资源已被删除或不存在。这种约定能显著降低联调成本，也便于后续扩展更多模块。
  </p>
  <h3>7.7 配置管理与可部署性</h3>
  <p>
    系统将数据库连接串、JWT 密钥、AI Key 等敏感信息从代码中剥离，统一使用环境变量配置。后端通过配置类读取 <code>backend/.env</code>，
    前端通过 <code>.env.local</code> 指定后端地址与会话 secret。该策略的好处是：开发、测试、部署环境可以使用不同配置，而无需修改源代码；
    同时避免敏感信息被提交到仓库，满足课程项目的基本安全要求。
  </p>

  <h2 id="s8">8. 测试与验收说明</h2>
  <p>
    在课程项目范围内，我们以“可运行、可操作、可演示”为目标完成自测。测试方式包含：接口自测（Postman/Apifox）、前端流程自测、异常场景测试。
    典型验收用例如下：
  </p>
  <ul>
    <li>注册新用户 → 登录 → 获取 /auth/me 验证鉴权</li>
    <li>创建作品 → 创建章节 → 编辑章节正文 → 检查作品字数/章节数是否更新</li>
    <li>新增角色/大纲/世界观 → 重新加载页面验证持久化</li>
    <li>配置 AI Key → 使用 AI 续写 → 将结果写入章节并保存</li>
    <li>导出 TXT/Markdown → 检查文件内容与章节顺序</li>
  </ul>
  <h3>8.1 接口自测（建议截图）</h3>
  <p>
    接口自测建议使用 Postman/Apifox。测试顺序遵循“先鉴权、再业务”的原则：先完成注册/登录拿到 token，再携带 token 测试作品、章节、设定等接口。
    这样可以把“鉴权问题”和“业务问题”分开定位，减少排错时间。
  </p>
  <table>
    <thead><tr><th>测试项</th><th>步骤</th><th>期望结果</th><th>备注/截图</th></tr></thead>
    <tbody>
      <tr>
        <td>健康检查</td>
        <td>GET /health</td>
        <td>返回 {"status":"ok"}</td>
        <td>建议截图：后端运行正常证明</td>
      </tr>
      <tr>
        <td>注册</td>
        <td>POST /auth/register（email/name/password）</td>
        <td>201 Created，返回用户信息</td>
        <td>建议截图：注册成功响应</td>
      </tr>
      <tr>
        <td>登录</td>
        <td>POST /auth/login（表单 username/password）</td>
        <td>返回 access_token</td>
        <td>建议截图：token 返回</td>
      </tr>
      <tr>
        <td>鉴权</td>
        <td>GET /auth/me（携带 Bearer token）</td>
        <td>返回当前用户信息</td>
        <td>建议截图：me 返回</td>
      </tr>
      <tr>
        <td>作品 CRUD</td>
        <td>POST /novels → GET /novels → GET/PUT/DELETE /novels/{id}</td>
        <td>创建/查询/修改/删除均成功</td>
        <td>建议截图：列表与详情接口</td>
      </tr>
      <tr>
        <td>章节 CRUD</td>
        <td>POST /novels/{id}/chapters → GET 列表 → PUT 更新 → DELETE 删除</td>
        <td>章节内容可保存，统计字段更新</td>
        <td>建议截图：统计字段变化</td>
      </tr>
      <tr>
        <td>设定模块</td>
        <td>角色/大纲/世界观接口分别测试</td>
        <td>可持久化保存并可查询</td>
        <td>建议截图：新增与查询</td>
      </tr>
    </tbody>
  </table>
  <h3>8.2 前端流程自测</h3>
  <p>
    前端流程自测以“从零开始”的方式进行：使用无痕窗口（避免 Cookie 干扰）→ 注册 → 登录 → 进入工作台 → 创建作品与章节 → 保存正文 → 添加设定 → 导出。
    自测重点关注：加载状态是否清晰、失败时提示是否可理解、空状态是否有引导、刷新后数据是否仍存在、错误时是否能快速回到可用状态。
  </p>
  <h3>8.3 异常场景与边界测试</h3>
  <p>
    为了避免演示时出现“页面白屏/无响应”，我们对常见异常场景做了验证：例如 token 过期/缺失、AI Key 未配置、数据库连接失败、接口返回非 JSON 等。
    对这些场景的处理策略是：给出明确提示，并保证主流程不被阻塞（例如 AI 未配置不影响写作与保存）。
  </p>
  <p class="muted">建议在答辩时按上述步骤演示，节奏清晰、成功率高。</p>

  <h2 id="s9">9. 组内分工与协作方式</h2>
  <p>
    两人小组采用“模块分工 + 联调协作”的方式推进。组长负责总体方案、后端与关键业务逻辑，组员负责前端页面与交互细节。
    在接口联调阶段共同确定数据结构与错误处理方式，并通过 GitHub 进行版本管理与阶段性提交，确保每个阶段都可回退、可追踪。
  </p>

  <h2 id="s10">10. 附录（目录结构与环境变量）</h2>
  <h3>10.1 项目目录结构（摘录）</h3>
  <pre><code>backend/
  app/
    api/        # 路由与依赖（auth/novels/chapters/...）
    models/     # ORM 模型
    schemas/    # Pydantic 模型
    services/   # 业务逻辑
    utils/      # 安全与工具函数
  requirements.txt

src/           # 前端主要页面与组件（Next.js）
public/        # 静态资源</code></pre>
  <h3>10.2 环境变量说明</h3>
  <p>后端（backend/.env）：</p>
  <pre><code>DATABASE_URL=...        # MySQL 连接串
SECRET_KEY=...          # JWT 密钥
ACCESS_TOKEN_EXPIRE_MINUTES=1440
DOUBAO_API_KEY=...      # AI Key（可选）</code></pre>
  <p>前端（.env.local）：</p>
  <pre><code>FASTAPI_URL=http://localhost:8000
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=please-change-me</code></pre>
  <h3>10.3 主要依赖（摘录）</h3>
  <p>
    下表列出本项目核心依赖（仅列关键部分），用于说明技术复杂度与实现基础。实际版本以项目依赖文件为准。
  </p>
  <table>
    <thead><tr><th>类别</th><th>依赖</th><th>用途说明</th></tr></thead>
    <tbody>
      <tr><td>前端</td><td>Next.js / React</td><td>页面渲染与路由、组件化开发</td></tr>
      <tr><td>前端 UI</td><td>TailwindCSS / Shadcn/ui</td><td>样式与组件体系，保证界面一致性</td></tr>
      <tr><td>认证</td><td>NextAuth</td><td>会话管理与登录流程</td></tr>
      <tr><td>后端</td><td>FastAPI</td><td>REST API 服务</td></tr>
      <tr><td>数据层</td><td>SQLAlchemy / Pydantic</td><td>ORM 建模与数据校验</td></tr>
      <tr><td>数据库</td><td>PyMySQL</td><td>MySQL 驱动</td></tr>
      <tr><td>AI</td><td>httpx</td><td>调用外部大模型接口</td></tr>
    </tbody>
  </table>
  <h3>10.4 可扩展方向（未来工作）</h3>
  <p>
    在当前课程范围内已完成核心闭环。若后续继续扩展，方向包括：增加作品封面上传与图床、引入版本历史与回滚（章节版本管理）、
    增加更细粒度的 AI 工具（例如根据角色设定自动生成对话风格）、增加协作写作与实时同步等。
  </p>

  <h2 id="s11">11. 源代码地址</h2>
  <p>GitHub 仓库地址：<span class="muted">（请粘贴你的 GitHub 链接）</span></p>
  <p class="muted">文档版本：v1.0</p>
</body>
</html>
