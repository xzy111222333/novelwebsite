<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>轻写（QingXie）系统使用与部署说明</title>
  <style>
    :root { --fg: #222; --muted: #666; --border: #cfcfcf; --bg-muted: #f6f6f6; }
    body { font-family: "Microsoft YaHei", "Noto Sans CJK SC", sans-serif; line-height: 1.85; margin: 32px; color: var(--fg); }
    h1, h2, h3, h4 { margin: 0 0 12px; }
    h1 { font-size: 26px; letter-spacing: 0.5px; }
    h2 { font-size: 18px; margin-top: 26px; padding-top: 6px; border-top: 1px solid #eee; }
    h3 { font-size: 15px; margin-top: 18px; }
    h4 { font-size: 14px; margin-top: 14px; }
    p { margin: 10px 0; }
    ul, ol { margin: 8px 0 8px 22px; }
    li { margin: 4px 0; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid var(--border); padding: 8px 10px; vertical-align: top; }
    th { background: #fafafa; }
    code { background: var(--bg-muted); padding: 1px 4px; border-radius: 4px; }
    pre { background: var(--bg-muted); padding: 12px; border-radius: 8px; overflow-x: auto; }
    .note { background: #fff7e6; padding: 10px 12px; border-left: 4px solid #f0b429; margin: 10px 0; }
    .callout { border-left: 4px solid #10b981; background: #ecfdf5; padding: 10px 12px; margin: 10px 0; }
    .muted { color: var(--muted); }
    .pagebreak { page-break-before: always; break-before: page; }
  </style>
</head>
<body>
  <h1>轻写（QingXie）系统使用与部署说明</h1>
  <p class="muted">文档用途：用于课程验收展示与部署参考，包含界面说明、运行步骤、数据库配置、常见问题处理与部署方案。</p>
  <p>组长：许正扬　　组员：龚哲炜　　版本：v1.0　　日期：2025-12-20</p>

  <h2>一、系统界面与功能说明（截图 + 文字说明）</h2>
  <p>
    本节建议按“页面截图 + 文字讲解”的方式呈现，截图数量尽量少但要覆盖核心流程。
    截图可以直接用浏览器截图或系统截图工具完成，再粘贴到最终 PDF 版本即可。
  </p>

  <h3>1. 首页（入口与介绍）</h3>
  <p>截图 1：系统首页。说明要点：系统定位、主要入口（登录/注册/进入工作台）。</p>
  <div class="note">此处插入：首页截图（建议包含导航栏、按钮与主标题）。</div>

  <h3>2. 注册与登录</h3>
  <p>
    注册页面用于创建账号，字段建议包含：邮箱、昵称、密码；登录页面输入邮箱与密码后进入系统。
    登录成功后会建立会话并访问受保护页面（写作工作台）。
  </p>
  <div class="note">此处插入：注册页截图（/auth/signup）。</div>
  <div class="note">此处插入：登录页截图（/auth/signin）。</div>

  <h3>3. 写作工作台（核心页面）</h3>
  <p>
    写作工作台是系统核心页面。一般由三部分构成：左侧/上方为作品与章节导航，中间为章节编辑器，右侧为 AI 与设定工具面板。
    用户可在此完成“创建作品 → 新建章节 → 编辑保存 → 使用 AI 辅助 → 导出”的完整流程。
  </p>
  <div class="note">此处插入：写作工作台总览截图（建议同时包含章节列表与编辑区）。</div>

  <h3>4. 作品库与资料区</h3>
  <p>
    作品库用于集中展示用户已创建的作品信息，并支持切换作品、查看更新日期、字数和章节数等概览数据。
    资料区用于存放创作相关素材（例如大纲、设定等入口），避免创作过程中的信息散落。
  </p>
  <div class="note">此处插入：作品库页面截图。</div>
  <div class="note">此处插入：资料区页面截图。</div>

  <h3>5. 设定模块（角色 / 大纲 / 世界观）</h3>
  <p>
    为了解决长篇创作中设定容易“前后矛盾”的问题，系统提供角色档案、世界观、章节大纲等结构化信息管理。
    这些信息会与作品绑定，写作时可随时查看与补充，形成“设定—正文”联动。
  </p>
  <div class="note">此处插入：角色工作室截图（至少一张）。</div>
  <div class="note">此处插入：章纲/世界观编辑截图（至少一张）。</div>

  <h3>6. AI 工具面板（续写/扩写/审稿等）</h3>
  <p>
    AI 面板用于在写作过程中提供辅助能力，常见操作是选择当前作品或章节，输入需求（续写方向、润色目标等），点击生成后得到结果文本。
    生成结果可直接复制或插入编辑器继续创作。该功能需要后端配置 AI Key。
  </p>
  <div class="note">此处插入：AI 续写面板截图（建议带上生成结果）。</div>

  <h2>二、运行环境与依赖说明</h2>
  <h3>1. 必需软件</h3>
  <table>
    <thead><tr><th>组件</th><th>版本建议</th><th>用途</th></tr></thead>
    <tbody>
      <tr><td>Node.js</td><td>18+</td><td>运行前端（Next.js）</td></tr>
      <tr><td>Python</td><td>3.10+</td><td>运行后端（FastAPI）</td></tr>
      <tr><td>MySQL</td><td>8.0</td><td>数据库（系统使用）</td></tr>
    </tbody>
  </table>

  <h3>2. 推荐开发工具</h3>
  <p>
    推荐使用 VS Code / PyCharm 进行开发调试；接口自测可使用 Postman 或 Apifox；数据库可使用 DataGrip 或 MySQL Workbench。
    本项目的后端提供健康检查接口与 FastAPI 自动生成的 Swagger 文档，便于快速验证接口是否正常。
  </p>

  <h2>三、本地运行（Windows 环境示例）</h2>
  <p>
    本节按“先后端、再前端”的顺序说明，数据库统一使用 MySQL。
  </p>
  <div class="callout">
    建议做法：使用 Python 虚拟环境（venv）隔离依赖，避免与系统全局 Python 包冲突。若使用 PowerShell 激活 venv 失败，可改用 CMD 或调整执行策略。
  </div>

  <h3>1. 后端启动（FastAPI）</h3>
  <h4>步骤 1：创建并激活虚拟环境（推荐）</h4>
  <pre><code>python -m venv .venv
.\.venv\Scripts\Activate.ps1</code></pre>
  <p class="muted">如果提示“脚本运行被禁止”，可以用 CMD 激活：<code>.\.venv\Scripts\activate.bat</code>。</p>

  <h4>步骤 2：安装依赖</h4>
  <pre><code>pip install -r backend/requirements.txt</code></pre>
  <p>依赖安装成功后，进入下一步启动服务。</p>

  <h4>步骤 3：启动服务</h4>
  <pre><code>uvicorn app.main:app --reload --app-dir backend</code></pre>
  <p>
    默认监听：<code>http://localhost:8000</code>。可通过健康检查确认后端状态：
    <code>GET http://localhost:8000/health</code>，返回 <code>{"status":"ok"}</code> 即表示正常。
  </p>
  <div class="callout">
    建议截图：后端启动终端截图 + /health 返回截图（可作为验收附件）。
  </div>

  <h4>步骤 4：查看接口文档（可选）</h4>
  <p>FastAPI 默认提供 Swagger 页面：<code>http://localhost:8000/docs</code>，可用来快速测试登录、作品、章节等接口。</p>

  <h3>2. 前端启动（Next.js）</h3>
  <h4>步骤 1：安装依赖</h4>
  <pre><code>npm install</code></pre>
  <h4>步骤 2：创建前端环境变量</h4>
  <p>在仓库根目录创建 <code>.env.local</code>（首次运行必须配置 secret，避免登录状态异常）：</p>
  <pre><code>FASTAPI_URL=http://localhost:8000
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=please-change-me</code></pre>
  <h4>步骤 3：启动开发服务器</h4>
  <pre><code>npm run dev</code></pre>
  <p>访问：<code>http://localhost:3000</code>。</p>

  <h3>3. 数据库配置（MySQL）</h3>
  <h4>3.1 MySQL 配置</h4>
  <p>
    本系统使用 MySQL 存储用户、作品、章节与设定数据。需要先创建数据库与用户，并在后端配置 <code>backend/.env</code> 中的 <code>DATABASE_URL</code>。
  </p>
  <p>（1）创建数据库（示例）</p>
  <pre><code>-- 登录 MySQL 后执行
CREATE DATABASE aiwrite_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</code></pre>
  <p>（2）创建普通用户并授权（示例，建议不要直接用 root 运行生产）</p>
  <pre><code>CREATE USER 'aiwrite_user'@'%' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON aiwrite_db.* TO 'aiwrite_user'@'%';
FLUSH PRIVILEGES;</code></pre>
  <p>（3）配置后端环境变量</p>
  <p>复制 <code>backend/.env.example</code> 为 <code>backend/.env</code>，修改如下：</p>
  <pre><code>DATABASE_URL=mysql+pymysql://aiwrite_user:123456@localhost:3306/aiwrite_db?charset=utf8mb4
SECRET_KEY=please-change-me
ACCESS_TOKEN_EXPIRE_MINUTES=1440</code></pre>
  <div class="note">
    若连接报错，请优先检查：MySQL 是否启动、端口是否为 3306、账号密码是否正确、数据库是否存在、是否安装 PyMySQL 依赖。
  </div>
  <h4>3.2 MySQL 安装与连接检查（补充说明）</h4>
  <p>
    Windows 下建议使用 MySQL Installer 安装 MySQL 8.0，并在安装过程中设置 root 密码与默认端口（3306）。
    安装完成后可通过“服务”确认 MySQL 服务已启动，或在命令行执行 <code>mysql -u root -p</code> 进入控制台验证连接。
    如出现连接被拒绝，请检查防火墙、端口占用与账号权限。
  </p>
  <h4>3.3 数据库备份（可选，模仿老师示例）</h4>
  <p>
    若后续需要将数据库备份到另一台机器或做验收备份，可使用 <code>mysqldump</code> 导出。注意在 Windows 下需要进入 MySQL 安装目录的 <code>bin</code> 目录执行。
  </p>
  <pre><code>mysqldump -u root -p --databases aiwrite_db &gt; aiwrite_db.sql</code></pre>
  <p>在目标机器创建数据库后可导入：</p>
  <pre><code>mysql -u root -p aiwrite_db &lt; aiwrite_db.sql</code></pre>

  <h2>四、系统使用流程（按验收步骤组织）</h2>
  <h3>1. 注册账号</h3>
  <p>
    在注册页填写邮箱与密码完成注册。注册成功后建议跳转登录页。
    若提示邮箱已存在，可更换邮箱或清空数据库后重试（验收演示建议准备一个新邮箱或提前建立测试账号）。
  </p>
  <h3>2. 登录进入系统</h3>
  <p>
    在登录页输入注册邮箱与密码。登录成功后进入写作工作台。若出现“登录后又自动退出”，通常是环境变量中的
    <code>NEXTAUTH_SECRET</code> 未固定或浏览器缓存了旧 Cookie，可清除 Cookie 后重试。
  </p>
  <h3>3. 创建作品</h3>
  <p>
    点击“新建作品”，输入作品标题、简介、类型与标签，创建成功后作品会出现在作品库并自动进入工作台可编辑状态。
  </p>
  <h3>4. 创建章节并写作</h3>
  <p>
    在作品下点击“新建章节”，输入章节标题后进入编辑器，编辑正文并保存。保存后系统会更新章节字数与作品统计数据。
    若需要调整章节顺序，可在章节管理界面进行拖拽排序并保存。
  </p>
  <h3>5. 维护设定（角色/大纲/世界观）</h3>
  <p>
    在侧边工具栏进入对应模块，补充角色性格与背景、故事大纲条目、世界观设定等信息。建议在开始写作前先建立基础设定，
    写作过程中再不断补全，以降低设定冲突。
  </p>
  <h3>6. 使用 AI 辅助写作（可选）</h3>
  <p>
    在后端配置 <code>DOUBAO_API_KEY</code> 后，用户可在 AI 面板中进行续写或润色。建议在演示时准备一个短章节内容作为上下文，
    便于现场展示 AI 的“输入—生成—插入”流程。
  </p>
  <h3>7. 导出作品</h3>
  <p>
    系统支持导出 TXT/Markdown，导出内容按章节顺序拼接，便于投稿或备份。验收时可展示导出的文件内容与章节标题格式。
  </p>

  <h2>五、部署说明（参考老师示例风格，给出可落地方案）</h2>
  <p>
    本节给出在 Linux 服务器上部署的通用方案：后端使用 Uvicorn（或 Gunicorn+UvicornWorker）运行，前端使用 Next.js production 模式运行，
    通过 Nginx 统一反向代理。若只需本地演示，可跳过本节。
  </p>

  <h3>1. 后端部署（Linux 参考）</h3>
  <p>（1）安装依赖并启动（简化方案）</p>
  <pre><code>pip install -r backend/requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8000 --app-dir backend</code></pre>
  <p>（2）建议使用 nohup 后台运行（示例）</p>
  <pre><code>nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 --app-dir backend &gt; backend.log 2&gt;&amp;1 &amp;</code></pre>
  <p>（3）生产环境建议：使用 systemd 管理进程（示例）</p>
  <p>
    在服务器上创建 <code>/etc/systemd/system/qingxie-backend.service</code>，内容如下（按实际路径修改）：
  </p>
  <pre><code>[Unit]
Description=QingXie FastAPI Backend
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/qingxie
Environment=\"DATABASE_URL=mysql+pymysql://...\"\nEnvironment=\"SECRET_KEY=...\"\nEnvironment=\"ACCESS_TOKEN_EXPIRE_MINUTES=1440\"
ExecStart=/opt/qingxie/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 --app-dir backend
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target</code></pre>
  <p>启用并启动：</p>
  <pre><code>sudo systemctl daemon-reload
sudo systemctl enable qingxie-backend
sudo systemctl start qingxie-backend
sudo systemctl status qingxie-backend</code></pre>

  <h3>2. 前端部署（Next.js production）</h3>
  <pre><code>npm install
npm run build
npm start</code></pre>
  <p>默认启动在 <code>http://localhost:3000</code>，部署时通过 Nginx 反向代理对外开放 80/443 端口。</p>
  <p>
    说明：<code>npm run build</code> 会生成生产构建产物（.next），<code>npm start</code> 以 production 模式启动服务。
    部署时建议将 <code>.env.local</code> 写好后再 build，以确保生产环境变量生效。
  </p>
  <p>（可选）使用 PM2 管理前端进程（示例）：</p>
  <pre><code>npm install -g pm2
pm2 start \"npm run start\" --name qingxie-frontend
pm2 save
pm2 status</code></pre>

  <h3>3. Nginx 反向代理示例（可选）</h3>
  <pre><code>server {
  listen 80;
  server_name your-domain.com;

  location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }

  location /fastapi/ {
    proxy_pass http://127.0.0.1:8000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
  }
}</code></pre>
  <div class="note">
    说明：实际代理路径可根据服务器规划调整。若前端直接调用后端域名，也可以省略 /fastapi 的代理配置。
  </div>

  <h2>六、常见问题与排查方法</h2>
  <h3>1. 前端无法登录或登录后立即失效</h3>
  <p>
    请检查 <code>.env.local</code> 中 <code>NEXTAUTH_SECRET</code> 是否固定；如果曾经变更过 secret，需要清除浏览器 Cookie 后重新登录。
    同时检查 <code>NEXTAUTH_URL</code> 是否为实际访问地址（本地通常为 <code>http://localhost:3000</code>）。
  </p>
  <h3>2. 后端 500 或数据库连接失败</h3>
  <p>
    请检查 <code>DATABASE_URL</code>、端口、账号权限与字符集；同时确认数据库 <code>aiwrite_db</code> 已创建且账号具备建表/读写权限。
  </p>
  <h3>3. AI 接口不可用</h3>
  <p>
    AI 功能需要配置 <code>DOUBAO_API_KEY</code>。未配置时属于预期行为，系统应提示“未配置 Key”。验收展示可准备已配置环境或说明为可选功能。
  </p>
  <h3>4. 端口冲突</h3>
  <p>
    默认前端 3000，后端 8000。若被占用，可更换端口：前端可设置 <code>PORT</code>，后端可在 uvicorn 命令中指定 <code>--port</code>。
  </p>

  <h2>七、验收演示建议流程（可直接照读）</h2>
  <p>
    演示建议控制在 5–8 分钟：先展示首页与登录 → 新建作品 → 新建章节并写入一段文本 → 保存并展示字数统计 → 新增角色/大纲/世界观 →（可选）演示 AI 续写 → 导出作品。
    过程中穿插展示后端 /health 与 /docs，证明前后端服务均正常运行。
  </p>

  <p class="muted">文档版本：v1.0（可根据老师要求继续补充截图与部署细节）。</p>
</body>
</html>
